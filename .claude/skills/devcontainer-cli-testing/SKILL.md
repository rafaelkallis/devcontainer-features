---
name: devcontainer-cli-testing
description: Knowledge about devcontainer CLI feature testing -- how to write tests, run them, structure scenarios, and diagnose failures
user-invokable: false
---

# Dev Container Feature Testing

Reference documentation for testing devcontainer features using the `devcontainer` CLI.

For the latest upstream documentation, fetch: https://raw.githubusercontent.com/teslamotors/devcontainers-cli/refs/heads/main/docs/features/test.md

---

## CLI Reference

```
devcontainer features test [options]
```

| Flag | Description |
|------|-------------|
| `-f, --features <feature...>` | Feature(s) to test (space-separated). If omitted, all features in `src/` are tested. |
| `-p, --project-folder <path>` | Path to folder containing `src/` and `test/` (default: `.`) |
| `-i, --base-image <image>` | Base image for autogenerated tests (default: `ubuntu:focal`). Not used for scenario tests. |
| `-u, --remote-user <user>` | Remote user for autogenerated tests. Not used for scenario tests. |
| `--skip-autogenerated` | Skip autogenerated tests (`test.sh`) |
| `--skip-scenarios` | Skip scenario tests |
| `--skip-duplicated` | Skip duplicate tests (`duplicate.sh`) |
| `--global-scenarios-only` | Run only `test/_global/` cross-feature tests |
| `--filter <string>` | Only run scenarios whose name contains the given string |
| `--log-level <level>` | Verbosity: `info` (default), `debug`, or `trace` |
| `--preserve-test-containers` | Keep containers alive after test run (useful for debugging) |

---

## Test Directory Structure

```
test/
  <feature-name>/
    test.sh              # Default autogenerated test script
    scenarios.json       # Scenario definitions
    <scenario-name>.sh   # Test script for a specific scenario
    duplicate.sh         # Idempotency test script
    <scenario-name>/     # Optional: extra build context files for a scenario
  _global/
    scenarios.json       # Cross-feature integration test definitions
    <scenario-name>.sh   # Cross-feature test scripts
```

---

## Test Library

Tests source `dev-container-features-test-lib` for structured assertions:

```bash
#!/bin/bash
set -e

source dev-container-features-test-lib

check "label" <command> [args...]   # Run command, record pass/fail
check "node installed" node --version
check "file exists" test -f /usr/local/bin/mytool

reportResults  # Print summary and exit non-zero if any check failed
```

- `check` captures the command's exit code. A zero exit code = pass; non-zero = fail.
- `reportResults` must be called at the end. It prints a summary and exits with a non-zero code if any check failed.

---

## Testing Modes

### 1. Autogenerated Tests (`test.sh`)

The CLI builds a minimal dev container with the feature installed using default options, then runs `test.sh` inside it. Useful for a quick sanity check of default behavior.

Skip with `--skip-autogenerated` if no `test.sh` exists.

### 2. Scenario Tests (`scenarios.json` + `<scenario-name>.sh`)

Scenarios let you define complex configurations: multiple features, specific option values, custom base images, and remote users. The CLI builds a container per scenario and runs the matching `.sh` script.

Skip with `--skip-scenarios`.

### 3. Duplicate Tests (`duplicate.sh`)

The CLI installs the feature twice with different options to verify idempotency. Controlled by environment variables (see below).

Skip with `--skip-duplicated`.

---

## `scenarios.json` Format

Each key is a scenario name mapping to a devcontainer.json snippet:

```json
{
  "my_scenario": {
    "image": "mcr.microsoft.com/devcontainers/base:ubuntu",
    "features": {
      "./src/my-feature": {
        "option1": "value1",
        "option2": true
      }
    },
    "remoteUser": "vscode"
  },
  "another_scenario": {
    "image": "ubuntu:jammy",
    "features": {
      "./src/my-feature": {}
    }
  }
}
```

- `image` -- base image for this scenario (overrides `-i`)
- `features` -- map of feature paths/IDs to option objects
- `remoteUser` -- optional; overrides `-u`

Use `./src/<feature-name>` to reference a feature from the local monorepo.

---

## Duplicate Test Environment Variables

When running `duplicate.sh`, the CLI sets environment variables for each install:

- `OPTION_NAME` -- option value for the first install
- `OPTION_NAME__DEFAULT` -- option value for the second install (defaults)

Example: for a feature with option `version`, the first install uses `$VERSION` and the second uses `$VERSION__DEFAULT`.

---

## Global Cross-Feature Tests (`test/_global/`)

`test/_global/scenarios.json` follows the same format as feature-level scenarios, but can reference multiple features at once. Useful for integration tests that verify features work together.

Run exclusively with `--global-scenarios-only`.

---

## Common Patterns

### Skip autogenerated when no `test.sh` exists

```bash
devcontainer features test -f my-feature --skip-autogenerated
```

### Debug a failing test

```bash
devcontainer features test -f my-feature --log-level debug
```

```bash
devcontainer features test -f my-feature --log-level debug --preserve-test-containers
```

### Run only a specific scenario

```bash
devcontainer features test -f my-feature --filter my_scenario
```

### Additional build context for a scenario

Place extra files under `test/<feature>/<scenario-name>/`. They are made available during container build for that scenario (e.g., config files, fixtures).

### Run global tests only

```bash
devcontainer features test --global-scenarios-only .
```

### Test with a specific base image (autogenerated only)

```bash
devcontainer features test -f my-feature -i ubuntu:jammy
```
